source("/Users/Edu/core/Projects/fast_strat/0_fstrat_init.R")

################# DATA ##############################################################################################################################
#####################################################################################################################################################
data        <- dbase("hf","EURUSD_2012_min.xts.rds","RDS")
X           <- to.minutes15(data)["20120105"]

################# PARAMETERS ########################################################################################################################
#####################################################################################################################################################
init            <- 1e4
norm            <- init*5

len_ema         <- 41

################# INDICATORS ########################################################################################################################
#####################################################################################################################################################
X$tday      <- trading_day(X,c(3,4,5))
X$ttime     <- trading_time(X,range="0600/1900")

X$ema       <- EMA(Cl(X), n=len_ema)

################# FRAMEWORK ##########################################################################################################################
######################################################################################################################################################
port_new(X)
for( t in 51:(nrow(X)-1)){
    #- essentials -----------------------------------------------------------
    time_date       <- time( X[ t ] )
    time_char       <- as.character( time_date )
    tday            <- as.numeric( X[   t  ,"tday"] )
    ttime           <- as.numeric( X[   t  ,"ttime"] )
    close           <- as.numeric( Cl(X[ t, ]) )

    #-          -------------
    ema             <- as.numeric( X[   t  ,"ema"] )

    bad_conditions  <- ( !tday || !ttime )
    #------------------------------------------------------------------------
    
    if( pos == 0 ) {
        if( close>ema ){
            order_add(price=close, qty=norm, time=t)
        }else if( close<ema ){
            order_add(price=close, qty=-norm, time=t)
        }else{ cat("0") }
    } else{
        if( pos > 0 ){
            if( close<ema ){
                order_add(price=close, qty=-pos, time=t)
            }else{ cat("L") }  
        } else if( pos < 0 ){
            if( close>ema ){
                order_add(price=close, qty=-pos, time=t)
            }else{ cat("S") }
        }else{ 
            cat(time_char, "wdf?") 
        }
    }
    #------------------------------------------------------------------------
    aggreg(t)
}
augmented   <- finalize(mkdata=mkdata, X=X, pricefun="close", init=init)

################# ANALYSIS ##########################################################################################################################
#####################################################################################################################################################
fast_plot(augmented)            # subset="20120806 04"

addEMA(len_ema)
# addLine(l=tp_vol_l,on=5)







